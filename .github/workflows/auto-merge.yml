name: Auto-Merge Approved PRs

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge if approved
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved' || github.event.check_suite.conclusion == 'success'
    
    steps:
    - name: Check PR status
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request?.number || 
                          context.payload.check_suite?.pull_requests[0]?.number;
          
          if (!prNumber) {
            console.log('No PR number found');
            return;
          }
          
          // Get PR details
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          // Check if PR has required approvals
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          const approvals = reviews.filter(review => review.state === 'APPROVED');
          const changesRequested = reviews.filter(review => review.state === 'CHANGES_REQUESTED');
          
          // Check if all checks passed
          const { data: checks } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          const allChecksPassed = checks.check_runs.every(check => 
            check.conclusion === 'success' || check.conclusion === 'skipped'
          );
          
          // Auto-merge conditions
          const hasApprovals = approvals.length >= 1;
          const noChangesRequested = changesRequested.length === 0;
          const isNotDraft = !pr.draft;
          const hasLabel = pr.labels.some(label => label.name === 'ready-for-review');
          
          console.log('PR Status:', {
            hasApprovals,
            noChangesRequested,
            allChecksPassed,
            isNotDraft,
            hasLabel
          });
          
          if (hasApprovals && noChangesRequested && allChecksPassed && isNotDraft && hasLabel) {
            // Add auto-merge label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['auto-merge']
            });
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'ðŸŽ‰ **Auto-merge approved!**\n\nAll checks passed and PR has been approved. Merging automatically...'
            });
            
            // Merge PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${prNumber})`,
                commit_message: pr.body || ''
              });
              
              console.log('PR merged successfully');
              
              // Delete branch if not main/develop
              if (!['main', 'develop'].includes(pr.head.ref)) {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${pr.head.ref}`
                });
                console.log('Branch deleted');
              }
            } catch (error) {
              console.error('Failed to merge:', error.message);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ Auto-merge failed: ${error.message}\n\nPlease merge manually.`
              });
            }
          } else {
            console.log('PR does not meet auto-merge criteria');
            
            let reason = [];
            if (!hasApprovals) reason.push('needs approval');
            if (changesRequested.length > 0) reason.push('has requested changes');
            if (!allChecksPassed) reason.push('checks not passing');
            if (pr.draft) reason.push('is draft');
            if (!hasLabel) reason.push('missing ready-for-review label');
            
            console.log('Reasons:', reason.join(', '));
          }
